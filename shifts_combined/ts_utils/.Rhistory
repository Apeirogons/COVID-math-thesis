#! /usr/bin/Rscript
library('ggplot2')
library('EpiEstim')
source('ts_utils/rl_cobey.R')
# SEIR
dist_to_infectious = read.csv('incubation_period.csv')
seir = read.csv('data/process_noise_SEIR.csv')
rls = get_RL(seir$obs_symptomatic_incidence, seir$t, dist_to_infectious$seir, max_iter=50, regularize=0.03)
rls=rls[rls['time'] >=0,]
seir$rl_deconv = rls$RL_result
plot = ggplot(seir) + geom_line(aes(x=X, y=obs_symptomatic_incidence, color='symptomatic incidence'))+ geom_line(aes(x=X, y=rl_deconv, color='deconvolved incidence')) + geom_line(aes(x=X, y=scaled_true_incidence, color='true incidence'))
print(plot)
ggsave(paste(paste('figures/', 'seir iterative RL', sep=''), '.png', sep=''))
write.csv(seir, 'data/process_noise_SEIR.csv', row.names = FALSE)
# Real
for (country in c('Canada', 'United States', 'United Kingdom', 'Japan', 'Germany', 'France')){
data = read.csv(paste(paste('data/', country, sep=''), '.csv', sep=''))
# Deconvolution step
rls = get_RL(data$new_cases_per_million, c(1:length(data$date)), dist_to_infectious$`real_world`, max_iter=50, regularize=0.1, right_censor=TRUE)
deconv_results = as.data.frame(rls)
deconv_results = deconv_results[deconv_results['time'] >= 1,]
deconv_results$date = as.Date(data$date)
deconv_results$original = data$new_cases_per_million
plot = ggplot(deconv_results) + geom_line(aes(x=date, y=original, color='original'))+ geom_line(aes(x=date, y=RL_result, color='deconvolved'))
print(plot)
ggsave(paste(paste('figures/', country, sep=''), '.png', sep=''))
data$rl_deconv = deconv_results$RL_result
write.csv(data, paste(paste('data/', country, sep=''), '.csv', sep=''))
}
